# FIREWALL FOR TP-LINK 1043ND
# Make by MUXA in 03.12.2015 v4.3 (EGAIS)

# Задаем путь до команды iptables 
IPTABLES="/usr/sbin/iptables"

# Запрет доступа в сеть Интернет для всех правил, не попавших в списки разрешенных
LAN="br-lan"
WIFI="wlan0"

# ACCEPT IP's without masquerade. Разрешаем доступ к IP адресам напрямую, без НАТа.
accept_ip="81.28.162.69 192.168.0.0/16 10.0.0.0/8 194.110.251.19 194.67.29.98 194.186.207.162 194.54.12.149 194.54.12.140 62.213.9.158 85.114.182.226 146.120.90.0/24"
dns_ip="8.8.8.8 8.8.4.4 217.113.115.150 217.113.114.100 81.28.160.1 81.28.160.111 10.0.0.0/8 192.168.0.0/16 85.116.62.225 85.116.63.225 62.213.0.12 62.213.2.1"
wan_name="eth0 eth2 3g-wan 3g-3G eth0.2 pppoe-wan"

  for WAN in $wan_name ; do
      $IPTABLES -I FORWARD 1 -i $LAN -o $WAN -j DROP
      $IPTABLES -I FORWARD 1 -i $WIFI -o $WAN -j DROP
      $IPTABLES -I INPUT 1 -i $WAN -j ACCEPT
      $IPTABLES -I FORWARD 1 -i $WAN -o $LAN -j ACCEPT

      for IP in $accept_ip ; do
               $IPTABLES -I FORWARD 1 -i $LAN -o $WAN -d $IP -j ACCEPT
      done
      
# DDOS DNS DROP 
#       for IP in $dns_ip ; do
#             $IPTABLES -I INPUT 1 -i $WAN -p tcp --dport 53 -s $IP -j ACCEPT
#      $IPTABLES -I INPUT 1 -i $WAN -p udp --dport 53 -s $IP -j ACCEPT
#      done
#         $IPTABLES -I INPUT -i $WAN -p tcp --dport 53 -j DROP
#        $IPTABLES -I INPUT -i $WAN -p udp --dport 53 -j DROP       
      done

# Разрешаем входящие пакеты с туннеля
$IPTABLES -I INPUT 1 -i tun0 -j ACCEPT
$IPTABLES -I FORWARD 1 -i tun0 -o $LAN -j ACCEPT
$IPTABLES -I FORWARD 1 -i $LAN -o tun0 -j ACCEPT
$IPTABLES -I FORWARD 1 -i $LAN -p udp --dport 123  -j ACCEPT    # NTP ACCEPT
$IPTABLES -I FORWARD 1 -i $LAN -p udp --dport 123  -j ACCEPT # NTP ACCEPT
